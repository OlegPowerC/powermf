## Краткое описание:
Управление параметрами пользователя осуществляется полностью в Active Directory (либо любой другой службе каталогов)
посредством задания атрибутов и членства в группах.

Сервис получает по протоколу RADIUS запрос на аутентификацию пользователя.
Производится поиск посльзователя в Active Directory
в случае успеха, проверяется его членство в группе, разрешающей подключение по VPN (параметр **otp_group** в секции **ldap_setting** файла **settings.json**)
если пользователь является членом этой группы, проверяются атрибуты:

Мобильный телефон **mobile**

Электронная почта **mail**

А так же Заметки на вкладке телефоны **info**

В поле Заметки можно указать предпочитаемый метод доставки одноразового пароля, либо **otpmail** либо **otpsms**
если в этом поле уже имеется текст, укажите метод доставки в конце текста, отделив его запятой или пробелом.

Для отправки SMS требуется промежуточный сервис (мы предоставляем интеграцию с СМС Дисконт)

### Параметры в файле settings.json

    Секция ldap_setting:
    fqdn                FQDN или IP адрес LDAP сервера.
    fqdn2               FQDN или IP адрес резервного LDAP сервера.
    ldap_port           LDAP порт (обычно 389)
    ldaps_port          LDAP over SSL порт (обычно 636)
    ldaps_enabled       включение LDAP over SSL (true/false)
    base_dn             узел в дереве откуда начинать поиск пользователей
    username_attr       атрибут имени пользователя, для Active Directory это sAMAccountName
    bind_username_upn   имя пользователя от имени которого будет производится обращение по LDAP к контроллеру домена
                        в формате UPN (username@domain)
    bind_password       пароль пользователя
    otp_group:          имя группы, членам которой разрешен доступ в VPN (в формате CN=<Группа>,CN=<контейнер>........,DC=<домен>,DC=local)
    a_phone_attr        альтернитивный атрибут в службе каталогов для телефонного номера
    a_mail_attr         альтернативный атрибут в службе каталогов для электронной почты
    a_method_attr       альтернативный атрибут в службе каталогов для указания метода доставки одноразового пароля
    otp_bypass_group    имя группы, членам которой разрешена аутентификация при вводе любого одноразового пароля
    fakepassword        не действительный пароль, который будет использоваться для блокировки пользователя в Active Directory
    nestedgroup         искать принадлежность пользователя к группе рекурсивно (вложенные группы) (true/false)    

    Секция radius_setting
    shared_secret       секректный ключ
    port                порт (обычно 1812)
    address             адрес на котором слушать Radius дейтаграммы (можно оставить пустым)
    ttimeotp            используется в тестовых целях и должен быть false

    Секция blockuser_params
    attemps             количество попыток ввода OTP (в случае блокировки в Active Directory, должно совпадать с политикой в домене)
    intime_mins         в течение какого времени, в минутах
    blockfor_mins       блокировать на время, в минутах (в случае блокировки в Active Directory, не имеет значения так как настраивается политикой в домене)
    enabled             0 - блокировка выключена, 1 - блокировка на уровне OTP, 2 - блокировка в Active Directory
    listblockedusers    Выводить в файл лога информацию о заблокированных пользователях
    country_list        использовать список блокировки по странам в файле countryacl.json, true/false
    iplist              использовать список блокировки по IP адресам в файле countryacl.json, true/false

    Секция otp_params:
    valid_interval      интервал в течении которого временный пароль действителен
    otp_len             количество цифр в одноразовом пароле - 6
    
    Секция smtp_params:
    mail_from           пользователь, от которого будет производится отправка письма
    mail_from_name      имя от кого будет отправлено письмо
    smtpserver          IP или FQDN адрес SMTP сервера
    username            имя пользователя для аутентификации на SMTP сервере
    smtpport            порт SMTP сервера
    subject             тема в письме
    message             текст помимо пароля
    domain              smtp домен, например yamdex.ru
    smtp_password       пароль на SMTP соединение
    tls                 укажите true если используется SMTP over TLS или укажите false для использования метода STARTTLS
    plain               если параметр установлен в true и параметр tls установлен в false, то отправка будет производится открытым текстом
    
    Секция sms_params:
    smsurl              URL шлюза SMS - сейчас возможен только СМС Дисконт - "https://api.iqsms.ru/messages/v2/send.json"
    smslogin            Имя пользователя для аутентификации на SMS шлюзе
    smspassword         Пароль для аутентификации на SMS шлюзе
    smscert             Сертификат для аутентификации на SMS шлюзе
    smskey              Закрытый ключ
    json                true - Использовать формат json (для указанного выше URL это так)
    smsca               корневой сертификат - не обязателен
    authbycert          Если аутентификация по логину/паролю то false, если по сертификату то true (для СМС Дисконт - false)
    checkidentity       true - если проверять валидность сертификата сервера и 0 если не проверять

### Блокировка аутентификации по IP адресам и/или старнам
В файле **countryacl.json** возможно указать какие IP и/или страны, разрешить/запретить.
Страны указываются в формате XX (так же как в базе данных RIPE), например RU, BY, US

### Параметры в файле countryacl.jso
    country_allowlist       список разрешенных стран
    country_denylist        список запрещенных стран
    country_na_block        блокировать пользователя, в случае невозможности получения информации о стране true/false
    country_default_block   если установлен как true, то будет использоваться список разрешенных стран country_allowlist, 
                            а все остальные блокируются, если же установлен как false, то используется список запрещенных стран,
                            country_denylist, а все остальные разрешены
    ip_allowlist            
    ip_denylist                 
    ip_default_block        если установлен как true, то будет использоваться список разрешенных IP адресов ip_allowlist, 
                            а все остальные блокируются, если же установлен как false, то используется список запрещенных адресов,
                            ip_denylist, а все остальные разрешены

Пример настройки:
Разрешены страны Россия и Беларусь, все остальные запрещены
Сеть 8.8.0.0/24 запрещена, все остальные разрешены

    {
        "country_allowlist": "BY,RU",
        "country_denylist": "",
        "country_na_block":true,
        "country_default_block":true,
        "ip_allowlist": "",
        "ip_deny": "8.8.0.0/16",
        "ip_default_block":false
    }

### Работа с Active Directory, подробное описание
Все управление пользователями, производится через Active Directory

Для того чтобы пользователь мог подключаться по VPN его необходимо сделать членом группы, указанной в конфигурационном файле
(параметр **otp_group** в секции **ldap_setting** файла **settings.json**),

если пользователь является членом этой группы, проверяются атрибуты:
Мобильный телефон (**mobile**), электронная почта (**mail**), а также Заметки на вкладке телефоны (**info**)
В поле Заметки можно указать предпочитаемый метод доставки одноразового пароля, **otpmail** для отправки одноразового пароля по электронной почте,
**otpsms** для отправки одноразового пароля по SMS или **otpwww** для отправки одноразового пароля по электронной почте на альтернативный почтовый ящик
указанный в атрибуте **wWWHomePage** .

Так же тут может хранится зашифрованный секретный ключ для генераторов TOTP, если в этом поле уже имеется текст, укажите метод доставки и если надо ключ,
в конце текста, отделив его запятой или пробелом.

В случае если атрибут **mobile** пустой, то будет использоваться атрибут **telephoneNumber**.

Так же, в случае если по каким то причинам, невозможно использовать выше указанные атрибуты, можно создать в схеме Active Directory дополнительные
атрибуты и указать их в файле settings.json следующими образом:
**a_phone_attr** приоритетный атрибут с телефонным номером
**a_mail_attr** приоритетный атрибут с телефонным адресом электронной почты
**a_method_attr** приоритетный атрибут с методом отправки и зашифрованным секретным ключем для генерации TOTP.

**Альтернативные атрибуты являются приоритетными.**

В связи с тем что на VPN шлюзах checkpoint нет возможности разрешить какой то части пользователей подключаться без одноразового пароля,
мы добавили возможность указать группу, члены которой могут вводить любой одноразовый пароль.
(параметр **otp_bypass_group** в секции **ldap_setting** файла **settings.json**).

#### Использование LDAP over SSL
Необходимо наличие действительного сертификата на сервере а так же установленного корневого сертификата
удостоверяющего центра, выдавшего сертификат для службы LDAP over SSL в доверенных корневых центрах
сертификации, на сервере где выполняется PowerMF.

Так же в настройках PowerMF нужно указать FQDN LDAPS сервера в случае если сертификат не содержит
альтернативного имени - IP адреса.

Далее рассмотрим работу с Active Directory а в качестве Linux OS на которой выполняется PowerMF считаем Red Hat и подобные OS
Добавим корневой сертификат нашего удостоверяющего центра в доверенные на Linux OS:

**yum install ca-certificates**

**update-ca-trust force-enable**

**cp ourrootca.crt /etc/pki/ca-trust/source/anchors/**

**update-ca-trust extract**

Посмотреть какой именно сертификат используется сервисом LDAP over SSL можно утилитой openssl:

**openssl s_client -showcerts -connect <LDAP over SSL сервер>:636**

Получив сертификат можно убедится кому и кем он выдан

### Использование генераторов одноразовых паролей (программных или аппаратных)

Для использования генераторов TOTP необходимо чтоб секретный ключ был известен обеим сторонам.
Существуют аппаратные TOTP токены с запрограммированным на производстве ключом, и программируемые.
Программные же в любом случае требуют ввода ключа.
Как правило, это можно сделать либо сканированием QR кода, либо вводом строки в формате Base32

Для безопасности мы храним в LDAP зашифрованный ключ в виде Base64 строки.

Если у вас уже есть ключ в формате Base32, вы можете его зашифровать при помощи утилиты **encryptkey**.

Она принимает следующие параметры:

**-p** пароль шифрования который указан в settings.json (“otp_key_encrypt”:)

**-k** секретный ключ в формате Base32

**-n** если секретный ключ нужно сгенерировать (тогда параметр -k указывать не надо)

**-qr** имя файла с QR кодом (указать без расширения, будет создан PNG фйл)

Если же его необходимо создать, то вы можете воспользоваться этой же утилитой, с параметром **-n**

а так же можно создать QR код в виде png файла и, например отправить его почтой.

Примеры работы с утилитой показаны ниже:

    encryptkey.exe -p secret1 -n -qr testuser
    Encrypted secret key for LDAP info:
    secretkey_UvbX5Cmr2uUVRc9DoBfj7VgZBtNUiu5ejmJhxvb3iVmvicgyOK90my1jm4hGUiaj
    Secret key in Base32 format: I6BRAZTMGU4BJSVDAWV2KMASEUJWWHJJ             
    QR code saved in: C:\Users\Tuser\Tools\testuser.png

## Блокировка пользователя при попытке подбора OTP
На данный момент существует возможность временной блокировки пользователя например на 15 минут, при нескольких подряд неуспешных попытках
в течение заданного времени.
За это отвечает секция **blockuser_params** в файле **settings.json**
Однако следует помнить, что если производятся попытки подбора OTP, значит пароль на учетную запись уже скомпроментирован.
Так же, есть возможность включить режим блокировки в Active Directory, тогда сохраняется концепция управления всем функционалом в Active Directory с одной стороны,
и позволит обратить внимание на факт утечки пароля учетной записи с другой стороны.

## Установка
Перейти в папку /opt

**cd /opt**

выполнить:
#### git clone https://github.com/OlegPowerC/powermf.git
перейти в папку powermf

**cd powermf**

сделать исполняемым файл init.sh

**chmod +x ./init.sh**

и выполнить его

**./init.sh**

Дождаться появления информации о лицензии и сохранить ее

Связаться с нами по e-mail: info@powerc.ru или по телефону и приобрести лицензию

После получения файла license.dat скопировать его в папку lic

Для запуска как сервис включить сервис

**systemctl enable /opt/powermf/powermf.service**

Запустить

**service powermf start**

Разрешить принимать дейтаграммы на нужный порт в файрволе

**firewall-cmd --zone=public --permanent --add-port=1812/udp**

**firewall-cmd --reload**

#### Журналирование
Журнал ведется в текстовый файл в папке ***logs***

### Отладка
В файле конфигурации есть параметры debuglevel, это глубина отладочной информации
Максимум 255
В случае запуска приложения из консоли, отладочная информация будет выводится на экран.
В случае запуска приложения как сервиса linux в ОС с systemd, отладочную информацию можно посмотреть в системном журнале:

**journalctl -u powermf**

### Утилита генерации секретного ключа для программного TOTP генератора
Утилиты лежат в папке **tools** под windows и linux

### Настройка шлюза VPN на примере Cisco ASA

    laaa-server ADLDAP protocol ldap
    aaa-server ADLDAP (inside) host 192.168.0.2
    server-port 389
    ldap-base-dn dc=EXAMPLE, dc=LOCAL
    ldap-scope subtree
    ldap-naming-attribute sAMAccountName
    ldap-login-password TestPass123
    ldap-login-dn cn=ASA, cn=Users, dc=EXAMPLE, dc=LOCAL
    server-type microsoft
    
    aaa-server RDTEST protocol radius
    aaa-server RDTEST (inside) host 192.168.0.5
    key radiuskeytest123
    authentication-port 1812
    
    tunnel-group TWTEST type remote-access
    tunnel-group TWTEST general-attributes
    authentication-server-group ADLDAP
    secondary-authentication-server-group RDTEST use-primary-username

В примере:
192.168.0.2 - это адрес LDAP сервера
192.168.0.5 - это адрес Linux хоста на котором запущен сервис PowerMF

###  Пример настройки Active Directory

![ad example image](https://github.com/OlegPowerC/powermf/blob/master/addata.png)


### Тест при использовании в качестве VPN шлюза, Cisco ASA

**test aaa-server authentication RDTEST host 192.168.0.5 username User password 123654**

В случае указывания реального пользователя - члена группы указанной в параметре otp_group
у которого есть токен (secretkey в поле info)
и пароля сгенерированного генератором OTP в логе будет сообщение:

INFO: Authentication Successful

В случае указания неверного пароля, в логе будет:

ERROR: Authentication Rejected: AAA failure

### Инструменты тестирования

Для проверки какие атрибуты будут использоваться, можно воспользоваться утилитой **testldap**
**./testldap  -u <Имя пользователя>**

Пример

    ./testldap  -u User1
    Пользователь User1 член группы CN=VTEST-VPN,CN=Users,DC=EXAMPLE,DC=LOCAL
    номер мобильного телефона (LDAP атрибут extensionAttribute6): +7XXXXXXX
    E-Mail (LDAP атрибут extensionAttribute8): user1@example.local
    Метод доставки сообщения (параметр в атрибуте extensionAttribute5): SMS на номер мобильного телефона

### Пример файла журнала с пояснениями

Пользователеь Usertest подключается не заполняя сразу поле второго пароля, он получает одноразовый пароль или по рочте или по SMS
    
    2025/02/19 19:28:49 NAS: 192.168.0.19:27203, client ip: 176.15.XXX.XXX, Sent OTP to user: Usertest, Challenge
    
Пользователь Usertest ввел полученый одноразовый пароль но ввел его неверно
    
    2025/02/19 19:29:13 NAS: 192.168.0.19:27203, client ip: 176.15.XXX.XXX,Invalid OTP, user: Usertest, Rejected
    2025/02/19 19:29:13 NAS: 192.168.0.19:27203, client ip: 176.15.XXX.XXX,Invalid OTP, user: Usertest, has been removed from the waiting list
    
Здесь показано, что в списке заблокированы пользователей есть Usertest, но он еще не заблокирован, а только ведется подсчет попыток ввода
    
    2025/02/19 19:29:24 Number of temporary blocked users in local blocklist: 1
    2025/02/19 19:29:24 User: Usertest, nuber of invalid OTP entered: 1 ,not blocked
    
Пользователеь Usertest подключается не заполняя сразу поле второго пароля, он получает одноразовый пароль или по рочте или по SMS
    
    2025/02/19 19:29:33 NAS: 192.168.0.19:27203, client ip: 176.15.XXX.XXX, Sent OTP to user: Usertest, Challenge
    
Пользователь Usertest ввел полученый одноразовый пароль верно
    
    2025/02/19 19:30:08 NAS: 192.168.0.19:27203, client ip: 176.15.XXX.XXX, User: Usertest, entered valid OTP, Accepted
    
Пользователеь Usertest подключается с внешним IP адресом, принадлещашим провайдеру США, а в списке разрешенных стран указана только RU
    
    2025/02/19 21:45:08 User: Usertest, client ip: 69.XX.XXX.XXX, blocked by ACL  country US is not in allow list , Reject

## Изменения и альнейшее развитие
В последней версии ПО, все флаги в конфигурационных файлах включено/выключено настраиваются одинаково: true/false
Добавлена возможность блокировки аутентификации по IP адресам или стране (данные о стране выбираются из базы данных RIPE)
В скором времени будет доступна версия под Windows (служба)